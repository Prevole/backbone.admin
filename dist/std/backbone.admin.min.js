/*
 * Backbone.Admin - v0.0.1
 * Copyright (c) 2013-03-15 Laurent Prevost (prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/backbone.admin
 */
(function(){var t={}.hasOwnProperty,e=function(e,r){function i(){this.constructor=e}for(var n in r)t.call(r,n)&&(e[n]=r[n]);return i.prototype=r.prototype,e.prototype=new i,e.__super__=r.prototype,e};window.Backbone.Admin=window.Admin=function(Backbone,t,r,i){var n,o,a,s,u,c,d,l,h;return o={version:"0.0.1"},a=!1,d=!1,l=RegExp(/[a-z]+(:[a-z]+)*/),u=new t.EventAggregator,s=null,h=function(t){var e;return e=r.map(t,function(t,e){return[e,t]}),r.sortBy(e,function(t){return t[1]})},n=function(){function t(t){var e;if(void 0===t||0===t.length)throw Error("The module name must be defined");e=t.split(":"),this.moduleName=e[0],void 0!==e[1]&&(this.actionName=e[1]),void 0!==e[2]&&(this.actionDetails=e[2])}return t.prototype.actionName="main",t.prototype.actionDetails=null,t.prototype.path=function(t){return void 0===this.actionDetails?""+t.actions[this.actionName]:""+t.actions[this.actionName]+"/"+this.actionDetails},t}(),o.ApplicationController=function(){function e(e){if(void 0===e)throw Error("An application must be defined");if(!(e instanceof t.Application))throw Error("Application should be Marionnette.Application");this.application=e,r.extend(this,Backbone.Events),this.listenTo(this.router,"route",this.routeHandler)}return e.prototype.modules={},e.prototype.router=new Backbone.Router,e.prototype.started=!1,e.prototype.routeHandler=function(t,e){return this.executeAction(new n(t),e)},e.prototype.executeAction=function(t,e){var i,n,o,a,s,u,c;for(n=this.modules[t.moduleName],o=n[t.actionName](e),u=r.keys(o),c=[],a=0,s=u.length;s>a;a++)i=u[a],void 0!==this.application[i]?c.push(this.application[i].show(o[i])):c.push(void 0);return c},e.prototype.action=function(t,e){var r,i,o;return r=new n(t),i=this.modules[r.moduleName],o=r.path(i),this.executeAction(r,e),this.router.navigate("/"+o)},e.prototype.registerModule=function(t){var e,i,n,a;if(void 0===t)throw Error("The module cannot be undefined");if(!(t instanceof o.Module))throw Error("The module must be from Admin.Module type");if(void 0!==this.modules[t.name])throw Error("The module is already registered");this.modules[t.name]=t,n=r.chain(t.actions).pairs().sortBy(1).object().value();for(i in n)a=n[i],e=""+t.name+":"+i,this.router.route(a,e);return this.listenTo(t,"action",this.action)},e.prototype.registerRegion=function(t,e){if(void 0!==this.application[t])throw Error("The region "+t+" is already registered");return this.application[t]=e},e.prototype.start=function(){return this.started?console.log("Application controller already started."):(this.application.start(),Backbone.history.start({pushState:!0}))},e}(),o.NavigationView=function(t){function r(){return r.__super__.constructor.apply(this,arguments)}return e(r,t),r.prototype.events={"click [data-action]":"action"},r.prototype.action=function(t){return t.preventDefault(),this.trigger("action",i(t.target).attr("data-action"))},r}(t.View),o.Module=function(){function t(){if(void 0===this.name)throw Error("The name of the module must be defined");if(void 0===this.actions)throw Error("At least one action must be defined");void 0===this.baseUrl&&(this.baseUrl="/"+this.name.replace(/:/g,"/")),r.extend(this,Backbone.Events)}var e;return t.prototype.action=function(t,e){return this.trigger("action",t,e)},e=function(){},t}(),o.CrudModule=function(t){function r(t){if(r.__super__.constructor.call(this,t),void 0===this.collection)throw Error("The collection must be specified");if(void 0===this.model&&void 0!==this.collection.prototype.model&&(this.model=this.collection.prototype.model),void 0===this.model)throw Error("The model must be specified")}var i;return e(r,t),i=function(){},r}(o.Module),o.MainRegion=function(t){function r(){return r.__super__.constructor.apply(this,arguments)}return e(r,t),r.prototype.el=".content",r}(t.Region),c={info:"datagrid.info",pager:{first:"datagrid.pager.first",last:"datagrid.pager.last",next:"datagrid.pager.next",previous:"datagrid.pager.previous",filler:"datagrid.pager.filler"}},o.setupDefaultI18nBindings=function(t){return c=r.defaults(t.i18n||{},c)},o.StatedCollection=Backbone.Collection.extend({initialize:function(){return this.current=r.defaults({},{page:1,ipp:2,quickSearch:"",sorting:{}})},sync:function(t,e,n){var o,a,s=this;return a=n.success,n.success=function(t,e){return a(t,e),s.trigger("fetched")},o=r.extend({},{jsonpCallback:"callback",timeout:25e3,cache:!1,type:"GET",dataType:"json",processData:!1,url:this.url,headers:{"X-Grid-Parameters":JSON.stringify(this.current)}},n),i.ajax(o)},parse:function(t){var e;return e=t.info,this.current.records=e.records,this.current.pages=e.pages,this.current.filteredRecords=e.filteredRecords,this.current.filteredPages=e.filteredPages,this.current.from=(this.current.page-1)*this.current.ipp+1,this.current.to=this.current.from+this.current.ipp-1,this.current.to>this.current.filteredRecords&&(this.current.to=this.current.filteredRecords),this.current.page>this.current.filteredPages&&this.current.filteredPages>0&&(this.current.page=this.current.filteredPages,this.fetch()),t.data},refresh:function(){return this.reset(),this.fetch()},getInfo:function(){return this.current},updateInfo:function(t){return this.current=r.defaults(t,this.current),this.fetch()}}),o.instanciateModule=function(t){var e;if(a)throw Error("Application already started, it is not possible to register more modules.");return e=new ModuleController(t),mainController.registerModule(e)},o.init=function(t){return d=!0,t=t||{},s=t.authorizator?new t.authorizator:new o.Authorizator},o.start=function(e){var r,i,n,s,c;if(d||o.init(),a=!0,void 0===e)throw Error("No option defined when some are required.");return i=void 0===e.mainRegion?o.MainRegion:e.mainRegion,n=null!=e.navigationView?e.navigationView:o.NavigationView,s=new Backbone.Router,c=function(t){return s.route(t,t,function(){return alert(t)}),s.navigate(t,{trigger:!0})},r=new t.Application,r.on("initialize:after",function(){return Backbone.history.start({pushState:!0})}),u.on("changeView",function(t){return r.mainRegion.show(t)}),r.addInitializer(function(){var t;return t=new n,t.on("navigate:switchModule",c),this.addRegions({mainRegion:i})}),r.start()},o.can=function(t,e){return s.can(t,e)},o.cannot=function(t,e){return s.cannot(t,e)},o}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender)}).call(this);