/*
 * Backbone.Admin - v0.0.1
 * Copyright (c) 2013-03-28 Laurent Prevost (prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/backbone.admin
 */
(function(){var t={}.hasOwnProperty,e=function(e,r){function i(){this.constructor=e}for(var o in r)t.call(r,o)&&(e[o]=r[o]);return i.prototype=r.prototype,e.prototype=new i,e.__super__=r.prototype,e};window.Backbone.Admin=window.Admin=function(Backbone,t,r,i){var o,n,u,a,s,c,l,d;return u={version:"0.0.1"},a=!1,l=!1,d=RegExp(/[a-z]+(:[a-z]+)*/),s=null,o=function(){function t(t,e,r,i){if(this.isRoutable=t,this.module=e,void 0===this.module)throw Error("The module must be defined");this.moduleName=this.module.name,void 0!==r&&(this.actionName=r),void 0!==i&&(this.options=i)}return t.prototype.module=null,t.prototype.actionName="main",t.prototype.options={},t.prototype.isRoutable=!1,t.prototype.path=function(){var t,e,r,i;if(void 0!==this.module.routableActions[this.actionName]){e=this.module.routableActions[this.actionName],i=this.options;for(t in i)r=i[t],e=e.replace(":"+t,r);return e}},t}(),n=new(function(){function t(){}return t.prototype.action=function(t,e,r){return new o(!1,t,e,r)},t.prototype.routeAction=function(t,e,r){return new o(!0,t,e,r)},t.prototype.outsideAction=function(t,e,r,i){return t?this.routeAction(e,r,i):this.action(e,r,i)},t}()),u.ApplicationController=function(){function e(t){var e=this;r.extend(this,Backbone.Events),t=r.defaults(t||{},{router:Backbone.Router}),this.router=r.isBoolean(t.router)&&t.router?new Backbone.Router:r.isFunction(t.router)?new t.router(t):t.router,this.on("action:outside:route",function(t,r){return a.call(e,t,!0,r)}),this.on("action:outside:noroute",function(t,r){return a.call(e,t,!1,r)}),this.on("action:done",function(t){return o.call(e,t)}),r.isNull(this.router)||this.listenTo(this.router,"route",function(t,r){return s.call(e,t,r)})}var i,o,a,s;return e.prototype.initializers=new t.Callbacks,e.prototype.triggerMethod=t.triggerMethod,e.prototype.modules={},e.prototype.regionNames=[],e.prototype.router=null,e.prototype.started=!1,e.prototype.addInitializer=function(t){return this.initializers.add(t)},e.prototype.start=function(t){return this.started?console.log("Application controller already started."):(this.triggerMethod("before:start",t),this.initializers.run(t,this),(!r.isNull(this.router)||Backbone.history.started)&&Backbone.history.start({pushState:!0}),this.triggerMethod("after:start",t))},a=function(t,e,r){var o,u,a;return u=t.split(":"),a=this.modules[u[0]],o=void 0===u[1]?"main":u[1],void 0!==a?i.call(this,n.outsideAction(e,a,o,r)):void 0},s=function(t,e){var o,u,a,s,c,l,d,h,p,f;if(u=t.split(":"),s=this.modules[u[0]],o=void 0===u[1]?"main":u[1],void 0!==s){if(c={},h=s.routableActions[o],void 0!==h&&(d=h.match(/(\(\?)?:\w+/g),!r.isNull(d)))for(a=p=0,f=d.length-1;f>=0?f>=p:p>=f;a=f>=0?++p:--p)l=d[a].slice(1),c[l]=e[a],e[a]=null;return c._params=r.filter(e,function(t){return!r.isNull(t)}),i.call(this,n.action(s,o,c))}},i=function(t){var e,i,o,n,u;if(i=t.module[t.actionName](t.options),!r.isNull(i)){for(u=r.keys(i),o=0,n=u.length;n>o;o++)e=u[o],void 0!==this[e]&&this[e].show(i[e]);return this.trigger("action:done",t)}},o=function(t){return!r.isNull(this.router)&&t.isRoutable?this.router.navigate(t.path()):void 0},e.prototype.registerModule=function(t){var e,o,n,a=this;if(void 0===t)throw Error("The module cannot be undefined");if(!(t instanceof u.Module))throw Error("The module must be from Admin.Module type");if(void 0!==this.modules[t.name])throw Error("The module is already registered");if(this.modules[t.name]=t,o=r.chain(t.routableActions).pairs().sortBy(1).object().value(),!r.isNull(this.router))for(e in o)n=o[e],this.router.route(n,""+t.name+":"+e);return this.listenTo(t,"action:module",function(t){return i.call(a,t)})},e.prototype.registerRegion=function(t,e){if(void 0!==this[t])throw Error("The region "+t+" is already registered");return this[t]=e,this.regionNames.push(t)},e}(),u.NavigationView=function(t){function r(){return r.__super__.constructor.apply(this,arguments)}return e(r,t),r.prototype.events={"click [data-action]":"action"},r.prototype.initialize=function(t){if(void 0===this.applicationController){if(void 0===t.applicationController)throw Error("An application controller must be defined");return this.applicationController=t.applicationController}},r.prototype.action=function(t){return t.preventDefault(),this.applicationController.trigger("action:outside:route",i(t.target).attr("data-action"))},r}(t.View),u.Module=t.Controller.extend({initialize:function(){if(void 0===this.name)throw Error("The name of the module must be defined");if(void 0===this.routableActions)throw Error("At least one routable action must be defined");return void 0===this.baseUrl?this.baseUrl="/"+this.name.replace(/:/g,"/"):void 0},routableAction:function(t,e,r){return this.trigger("action:module",n.routeAction(this,t,e),r)},action:function(t,e){return this.trigger("action:module",n.action(this,t,e))}}),u.CrudModule=u.Module.extend({initialize:function(t){if(this["super"](t),void 0===this.collection)throw Error("The collection must be specified");if(void 0===this.model&&void 0!==this.collection.prototype.model&&(this.model=this.collection.prototype.model),void 0===this.model)throw Error("The model must be specified")}}),u.MainRegion=function(t){function r(){return r.__super__.constructor.apply(this,arguments)}return e(r,t),r.prototype.el=".content",r}(t.Region),c={info:"datagrid.info",pager:{first:"datagrid.pager.first",last:"datagrid.pager.last",next:"datagrid.pager.next",previous:"datagrid.pager.previous",filler:"datagrid.pager.filler"}},u.setupDefaultI18nBindings=function(t){return c=r.defaults(t.i18n||{},c)},u.StatedCollection=Backbone.Collection.extend({initialize:function(){return this.current=r.defaults({},{page:1,ipp:2,quickSearch:"",sorting:{}})},sync:function(t,e,o){var n,u,a=this;return u=o.success,o.success=function(t,e){return u(t,e),a.trigger("fetched")},n=r.extend({},{jsonpCallback:"callback",timeout:25e3,cache:!1,type:"GET",dataType:"json",processData:!1,url:this.url,headers:{"X-Grid-Parameters":JSON.stringify(this.current)}},o),i.ajax(n)},parse:function(t){var e;return e=t.info,this.current.records=e.records,this.current.pages=e.pages,this.current.filteredRecords=e.filteredRecords,this.current.filteredPages=e.filteredPages,this.current.from=(this.current.page-1)*this.current.ipp+1,this.current.to=this.current.from+this.current.ipp-1,this.current.to>this.current.filteredRecords&&(this.current.to=this.current.filteredRecords),this.current.page>this.current.filteredPages&&this.current.filteredPages>0&&(this.current.page=this.current.filteredPages,this.fetch()),t.data},refresh:function(){return this.reset(),this.fetch()},getInfo:function(){return this.current},updateInfo:function(t){return this.current=r.defaults(t,this.current),this.fetch()}}),u.instanciateModule=function(t){var e;if(a)throw Error("Application already started, it is not possible to register more modules.");return e=new ModuleController(t),mainController.registerModule(e)},u.init=function(t){return l=!0,t=t||{},s=t.authorizator?new t.authorizator:new u.Authorizator},u.start=function(e){var r,i,o,n,s;if(l||u.init(),a=!0,void 0===e)throw Error("No option defined when some are required.");return i=void 0===e.mainRegion?u.MainRegion:e.mainRegion,o=null!=e.navigationView?e.navigationView:u.NavigationView,n=new Backbone.Router,s=function(t){return n.route(t,t,function(){return alert(t)}),n.navigate(t,{trigger:!0})},r=new t.Application,r.on("initialize:after",function(){return Backbone.history.start({pushState:!0})}),gvent.on("changeView",function(t){return r.mainRegion.show(t)}),r.addInitializer(function(){var t;return t=new o,t.on("navigate:switchModule",s),this.addRegions({mainRegion:i})}),r.start()},u.can=function(t,e){return s.can(t,e)},u.cannot=function(t,e){return s.cannot(t,e)},u}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender)}).call(this);