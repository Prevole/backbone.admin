/*!
 * Backbone.Admin v0.0.1
 * Copyright (c) 2013 Laurent Pr√©vost (prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/backbone.admin
 */
var Admin,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Backbone.Admin=Admin=function(e,t,n,r){var i,s,o,u,a,f,l,c,h;return Admin={version:"0.0.1"},o=!1,l=!1,h=new RegExp(/[a-z]+(:[a-z]+)*/),a=new t.EventAggregator,u=null,Admin.Authorizator=function(){function e(){}return e.prototype.can=function(e,t){return!0},e.prototype.cannot=function(e,t){return!this.can(e,t)},e}(),Admin.MainRegion=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.el=".content",t.prototype.open=function(e){var t=this;return this.$el.html(e.el),this.$el.show("slide",{direction:"up"},1e3,function(){return e.trigger("transition:open")})},t.prototype.show=function(e){var n=this;return this.$el?r(this.el).hide("slide",{direction:"up"},1e3,function(){return e.trigger("transition:show"),t.__super__.show.call(n,e)}):t.__super__.show.call(this,e)},t}(t.Region),i=function(){function t(e){this.modules={}}var e;return t.prototype.registerModule=function(e){if(e!==void 0&&e instanceof s){if(this.modules[e.getName()]!==void 0)throw new Error("The module "+e.getName()+" is already instanciated.");return this.modules[e.getName()]=e}throw new Error("The module is not defined or not an instance of Module class")},t.prototype.switchModule=function(t,n){var r;return n==null&&(n=!0),alert(t),r=e.call(this,t),History.navigate("/books"),a.trigger("changeView",new r.gridLayoutClass)},t.prototype.crudView=function(e,t,n){var r;r=e.prototype.controller;switch(t){case"create":r.getRouter().changeUrl(t);break;case"edit":r.getRouter().changeUrl(t,{id:n.model.get("id")})}return a.trigger("changeView",new e(n))},e=function(e){if(this.modules[e])return this.modules[e];throw new Error("The module "+e+" is not registered.")},t}(),c=new i,Admin.FormView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.events={"click .cancel":"cancel","click .create":"create","click .update":"update"},t.prototype.serializeData=function(){return this.template},t.prototype.getAttributes=function(){throw new Error("Missing method getAttributes().")},t.prototype.create=function(e){var t=this;return e.preventDefault(),this.model.set(this.getAttributes.call(this)),this.controller.collection.create(this.model,{wait:!0,success:function(e,n){return c.switchModule(t.controller.name)},error:function(e,n){return t.handleErrors(e,n)}})},t.prototype.update=function(e){var t=this;return e.preventDefault(),this.model.save(this.getAttributes.call(this),{success:function(e,n){return c.switchModule(t.controller.name)},error:function(e,n){return t.handleErrors(e,n)}})},t.prototype.cancel=function(e){return e.preventDefault(),c.switchModule(this.controller.name)},t.prototype.handleErrors=function(e,t){return console.log("Server side validation failed.")},t}(e.Marionette.ItemView),s=function(){function p(e){if(e===void 0)throw new Error("No option defined when some are required.");if(e.moduleName==null)throw new Error("No module defined or not a string.");if(!h.test(e.moduleName))throw new Error("The module name is incorect.");this.name=e.moduleName,this.moduleBaseUrl="/"+this.name.replace(/:/g,"/"),this.moduleBaseRoute=this.moduleBaseUrl.replace(/^\//,""),this.pagesBasePath=e.pagesBasePath!=null?e.pagesBasePath.replace(/\/$/,""):null,this.templatePath=this.pagesBasePath?""+this.pagesBasePath+"/"+this.moduleBaseRoute:this.moduleBaseRoute,a.call(this,e.model),i.call(this,e.collection),u.call(this,e.gridLayout),s.call(this,e.createView),o.call(this,e.editView)}var t,n,i,s,o,u,a,f,l;return p.prototype.getName=function(){return this.name},a=function(t){return t?this.modelClass=t:this.modelClass=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t}(e.Model),this.modelClass.prototype.controller=this},i=function(e){if(e){this.collectionClass=e,this.collectionClass.prototype.url||(this.collectionClass.prototype.url=modulePath);if(!this.collectionClass.prototype.model)return this.collectionClass.prototype.model=this.modelClass}},u=function(e){if(Admin.Dg&&!e)return this.gridLayoutClass=Admin.Dg.createDefaultLayout({collection:this.collection,gridRegions:{table:{view:Admin.Dg.DefaultTableView.extend({itemView:Admin.Dg.createRowView(this.modelClass,""+this.templatePath+"/row"),headerView:Admin.Dg.createTableHeaderView(""+this.templatePath+"/headers")})}}})},s=function(e){if(e)return this.createViewClass=e.extend({model:this.modelClass}),this.createViewClass.prototype.controller=this},o=function(e){if(e)return this.editViewClass=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t}(e),this.editViewClass.prototype.controller=this},f=function(e){switch(e){case"create":return this.createViewClass.prototype.template!==void 0;case"edit":return this.editViewClass.prototype.template!==void 0}},l=function(e,t,i){var s,o=this;return e==="create"?s=""+this.collection.url+"/new":s=""+this.collection.url+"/"+i.model.get("id")+"/"+e,r.ajax({type:"GET",dataType:"html",processData:!1,url:s,success:function(r){switch(e){case"create":o.createViewClass.prototype.template=r;break;case"edit":o.editViewClass.prototype.template=r}return t(n.call(o,e),e,i)}})},n=function(e){switch(e){case"create":return this.createViewClass;case"edit":return this.editViewClass}},t=function(e,t){var r;return r=function(e,t,n){return c.crudView(e,t,n)},f.call(this,e)?r(n.call(this,e),e,t):l.call(this,e,r,t)},p.prototype.grid=function(){return c.switchModule(this.name,!1)},p.prototype.refresh=function(){return this.collection.refresh()},p.prototype.create=function(e){return t.call(this,"create",{model:e})},p.prototype.edit=function(e){return t.call(this,"edit",{model:e})},p}(),Admin.NavigationView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.switchModule=function(e){return this.trigger("navigate:switchModule",e)},t}(t.View),f={info:"datagrid.info",pager:{first:"datagrid.pager.first",last:"datagrid.pager.last",next:"datagrid.pager.next",previous:"datagrid.pager.previous",filler:"datagrid.pager.filler"}},Admin.setupDefaultI18nBindings=function(e){return f=n.defaults(e.i18n||{},f)},Admin.StatedCollection=e.Collection.extend({initialize:function(e){return this.current=n.defaults({},{page:1,ipp:2,quickSearch:"",sorting:{}})},sync:function(e,t,i){var s,o,u=this;return o=i.success,i.success=function(e,t){return o(e,t),u.trigger("fetched")},s=n.extend({},{jsonpCallback:"callback",timeout:25e3,cache:!1,type:"GET",dataType:"json",processData:!1,url:this.url,headers:{"X-Grid-Parameters":JSON.stringify(this.current)}},i),r.ajax(s)},parse:function(e,t){var n;return n=e.info,this.current.records=n.records,this.current.pages=n.pages,this.current.filteredRecords=n.filteredRecords,this.current.filteredPages=n.filteredPages,this.current.from=(this.current.page-1)*this.current.ipp+1,this.current.to=this.current.from+this.current.ipp-1,this.current.to>this.current.filteredRecords&&(this.current.to=this.current.filteredRecords),this.current.page>this.current.filteredPages&&this.current.filteredPages>0&&(this.current.page=this.current.filteredPages,this.fetch()),e.data},refresh:function(){return this.reset(),this.fetch()},getInfo:function(){return this.current},updateInfo:function(e){return this.current=n.defaults(e,this.current),this.fetch()}}),Admin.instanciateModule=function(e){var t;if(o)throw new Error("Application already started, it is not possible to register more modules.");return t=new s(e),c.registerModule(t)},Admin.init=function(e){return l=!0,e=e||{},e.authorizator?u=new e.authorizator:u=new Admin.Authorizator},Admin.start=function(n){var r,i,s;l||Admin.init(),o=!0;if(n===void 0)throw new Error("No option defined when some are required.");return n.mainRegion===void 0?i=Admin.MainRegion:i=n.mainRegion,n.navigationView!=null?s=n.navigationView:s=Admin.NavigationView,r=new t.Application,r.on("initialize:after",function(){return e.history.start({pushState:!0})}),a.on("changeView",function(e){return r.mainRegion.show(e)}),r.addInitializer(function(){var e;return e=new s,e.on("navigate:switchModule",c.switchModule,c),this.addRegions({mainRegion:i})}),r.start()},Admin.can=function(e,t){return u.can(e,t)},Admin.cannot=function(e,t){return u.cannot(e,t)},Admin}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender);