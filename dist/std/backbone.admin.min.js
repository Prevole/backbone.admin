/*!
 * Backbone.Admin v0.0.1
 * Copyright (c) 2013 Laurent Pr√©vost (prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/backbone.admin
 */
var Admin,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Backbone.Admin=Admin=function(e,t,n,r){var i,s,o,u,a,f;return Admin={version:"0.0.1"},i=!1,a=!1,f=new RegExp(/[a-z]+(:[a-z]+)*/),o=new t.EventAggregator,s=null,Admin.ApplicationController=function(){function i(r){if(r===void 0)throw new Error("An application must be defined");if(!(r instanceof t.Application))throw new Error("Application should be Marionnette.Application");this.application=r,n.extend(this,e.Events)}return i.prototype.modules={},i.prototype.router=new e.Router,i.prototype.started=!1,i.prototype.action=function(e,t){var r,i,s,o,u,a,f,l,c,h,p=this;e.match(/.*:.*/g)?(o=e.replace(/:.*/,""),r=e.replace(/.*:/,""),a=""+o+"/"+r):(o=e,r="defaultAction",a=o),s=this.modules[o],u=s[s.getRoutableActions()[r]](t),h=n.keys(u),f=function(e){if(p.application[e]!==void 0)return p.application[e].show(u[e])};for(l=0,c=h.length;l<c;l++)i=h[l],f(i);return this.router.route(a,e),this.router.navigate(""+a,{trigger:!0})},i.prototype.registerModule=function(e){if(e===void 0)throw new Error("The module cannot be undefined");if(e instanceof Admin.Module){if(this.modules[e.name]!==void 0)throw new Error("The module is already registered");return this.modules[e.name]=e,this.listenTo(e,"action",this.action)}throw new Error("The module must be from Admin.Module type")},i.prototype.registerRegion=function(e,t){if(this.application[e]!==void 0)throw new Error("The region "+e+" is already registered");return this.application[e]=t},i.prototype.start=function(){return this.started?console.log("Application controller already started."):(this.application.start(),e.history.start({pushState:!0}),r(window).bind("popstate",function(e){return alert(e.originalEvent.state)}))},i}(),Admin.NavigationView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.events={"click [data-action]":"action"},t.prototype.action=function(e){return e.preventDefault(),this.trigger("action",r(e.target).attr("data-action"))},t}(t.View),Admin.Module=function(){function r(t){if(this.name===void 0)throw new Error("The name of the module must be defined");this.baseUrl===void 0&&(this.baseUrl="/"+this.name.replace(/:/g,"/"));if(this.routableActions===void 0)throw new Error("At least one routable action must be defined");n.extend(this,e.Events)}var t;return r.prototype.getRoutableActions=function(){return this.routableActions},r.prototype.getActions=function(){if(this.actions===void 0)throw new Error("No action are defined");return this.actions},r.prototype.action=function(e,t){return this.trigger("action",e,t)},t=function(e){},r}(),Admin.CrudModule=function(e){function n(e){n.__super__.constructor.call(this,e);if(this.collection===void 0)throw new Error("The collection must be specified");this.model===void 0&&this.collection.prototype.model!==void 0&&(this.model=this.collection.prototype.model);if(this.model===void 0)throw new Error("The model must be specified")}var t;return __extends(n,e),t=function(e){},n}(Admin.Module),Admin.MainRegion=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.el=".content",t}(t.Region),u={info:"datagrid.info",pager:{first:"datagrid.pager.first",last:"datagrid.pager.last",next:"datagrid.pager.next",previous:"datagrid.pager.previous",filler:"datagrid.pager.filler"}},Admin.setupDefaultI18nBindings=function(e){return u=n.defaults(e.i18n||{},u)},Admin.StatedCollection=e.Collection.extend({initialize:function(e){return this.current=n.defaults({},{page:1,ipp:2,quickSearch:"",sorting:{}})},sync:function(e,t,i){var s,o,u=this;return o=i.success,i.success=function(e,t){return o(e,t),u.trigger("fetched")},s=n.extend({},{jsonpCallback:"callback",timeout:25e3,cache:!1,type:"GET",dataType:"json",processData:!1,url:this.url,headers:{"X-Grid-Parameters":JSON.stringify(this.current)}},i),r.ajax(s)},parse:function(e,t){var n;return n=e.info,this.current.records=n.records,this.current.pages=n.pages,this.current.filteredRecords=n.filteredRecords,this.current.filteredPages=n.filteredPages,this.current.from=(this.current.page-1)*this.current.ipp+1,this.current.to=this.current.from+this.current.ipp-1,this.current.to>this.current.filteredRecords&&(this.current.to=this.current.filteredRecords),this.current.page>this.current.filteredPages&&this.current.filteredPages>0&&(this.current.page=this.current.filteredPages,this.fetch()),e.data},refresh:function(){return this.reset(),this.fetch()},getInfo:function(){return this.current},updateInfo:function(e){return this.current=n.defaults(e,this.current),this.fetch()}}),Admin.instanciateModule=function(e){var t;if(i)throw new Error("Application already started, it is not possible to register more modules.");return t=new ModuleController(e),mainController.registerModule(t)},Admin.init=function(e){return a=!0,e=e||{},e.authorizator?s=new e.authorizator:s=new Admin.Authorizator},Admin.start=function(n){var r,s,u,f,l;a||Admin.init(),i=!0;if(n===void 0)throw new Error("No option defined when some are required.");return n.mainRegion===void 0?s=Admin.MainRegion:s=n.mainRegion,n.navigationView!=null?u=n.navigationView:u=Admin.NavigationView,f=new e.Router,l=function(e){return f.route(e,e,function(){return alert(e)}),f.navigate(e,{trigger:!0})},r=new t.Application,r.on("initialize:after",function(){return e.history.start({pushState:!0})}),o.on("changeView",function(e){return r.mainRegion.show(e)}),r.addInitializer(function(){var e;return e=new u,e.on("navigate:switchModule",l),this.addRegions({mainRegion:s})}),r.start()},Admin.can=function(e,t){return s.can(e,t)},Admin.cannot=function(e,t){return s.cannot(e,t)},Admin}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender);