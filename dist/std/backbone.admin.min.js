/*!
 * Backbone.Admin v0.0.1
 * Copyright (c) 2013 Laurent Pr√©vost (prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/backbone.admin
 */
var Admin,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Backbone.Admin=Admin=function(e,t,n,r){var i,s,o,u,a,f,l,c,h;return Admin={version:"0.0.1"},o=!1,l=!1,h=new RegExp(/[a-z]+(:[a-z]+)*/),a=new t.EventAggregator,u=null,Admin.Authorizator=function(){function e(){}return e.prototype.can=function(e,t){return!0},e.prototype.cannot=function(e,t){return!this.can(e,t)},e}(),Admin.MainRegion=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.el=".content",t.prototype.open=function(e){var t=this;return this.$el.html(e.el),this.$el.show("slide",{direction:"up"},1e3,function(){return e.trigger("transition:open")})},t.prototype.show=function(e){var n=this;return this.$el?r(this.el).hide("slide",{direction:"up"},1e3,function(){return e.trigger("transition:show"),t.__super__.show.call(n,e)}):t.__super__.show.call(this,e)},t}(t.Region),i=function(){function t(e){this.modules={}}var e;return t.prototype.registerModule=function(e){if(e!==void 0&&e instanceof s){if(this.modules[e.getName()]!==void 0)throw new Error("The module "+e.getName()+" is already instanciated.");return this.modules[e.getName()]=e}throw new Error("The module is not defined or not an instance of Module class")},t.prototype.switchModule=function(t,n){var r;return n==null&&(n=!0),r=e.call(this,t),n&&r.getRouter().changeUrl("grid"),a.trigger("changeView",new r.gridLayoutClass)},t.prototype.crudView=function(e,t,n){var r;r=e.prototype.controller;switch(t){case"create":r.getRouter().changeUrl(t);break;case"edit":r.getRouter().changeUrl(t,{id:n.model.get("id")})}return a.trigger("changeView",new e(n))},e=function(e){if(this.modules[e])return this.modules[e];throw new Error("The module "+e+" is not registered.")},t}(),c=new i,Admin.FormView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.events={"click .cancel":"cancel","click .create":"create","click .update":"update"},t.prototype.serializeData=function(){return this.template},t.prototype.getAttributes=function(){throw new Error("Missing method getAttributes().")},t.prototype.create=function(e){var t=this;return e.preventDefault(),this.model.set(this.getAttributes.call(this)),this.controller.collection.create(this.model,{wait:!0,success:function(e,n){return c.switchModule(t.controller.name)},error:function(e,n){return t.handleErrors(e,n)}})},t.prototype.update=function(e){var t=this;return e.preventDefault(),this.model.save(this.getAttributes.call(this),{success:function(e,n){return c.switchModule(t.controller.name)},error:function(e,n){return t.handleErrors(e,n)}})},t.prototype.cancel=function(e){return e.preventDefault(),c.switchModule(this.controller.name)},t.prototype.handleErrors=function(e,t){return console.log("Server side validation failed.")},t}(e.Marionette.ItemView),s=function(){function d(e){if(e===void 0)throw new Error("No option defined when some are required.");if(e.moduleName==null)throw new Error("No module defined or not a string.");if(!h.test(e.moduleName))throw new Error("The module name is incorect.");this.name=e.moduleName,this.moduleBaseUrl="/"+this.name.replace(/:/g,"/"),this.moduleBaseRoute=this.moduleBaseUrl.replace(/^\//,""),this.pagesBasePath=e.pagesBasePath!=null?e.pagesBasePath.replace(/\/$/,""):null,this.templatePath=this.pagesBasePath?""+this.pagesBasePath+"/"+this.moduleBaseRoute:this.moduleBaseRoute,this.vent=new t.EventBinder,f.call(this,e.model),s.call(this,e.collection),a.call(this,e.gridLayout),o.call(this,e.createView),u.call(this,e.editView)}var n,i,s,o,u,a,f,l,p;return d.prototype.getName=function(){return this.name},d.prototype.setRouter=function(e){return this.router=e},d.prototype.getRouter=function(){return this.router},d.prototype.getRoutes=function(){var e;return e={},e[""+this.moduleBaseRoute]="grid",e[""+this.moduleBaseRoute+"/new"]="create",e[""+this.moduleBaseRoute+"/:id/edit"]="edit",this.routePaths={},this.routePaths.grid=this.moduleBaseRoute,this.routePaths.create=""+this.moduleBaseRoute+"/new",this.routePaths.edit=""+this.moduleBaseRoute+"/:id/edit",e},d.prototype.getRoute=function(e){return this.routePaths[e]},f=function(t){return t?this.modelClass=t:this.modelClass=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t}(e.Model),this.modelClass.prototype.controller=this},s=function(e){return e?(this.collectionClass=e,this.collectionClass.prototype.url||(this.collectionClass.prototype.url=modulePath),this.collectionClass.prototype.model||(this.collectionClass.prototype.model=this.modelClass)):this.collectionClass=Ajadmin.StatedCollection.extend({url:this.moduleBaseUrl,model:this.modelClass}),this.collection=new this.collectionClass},a=function(e){if(Ajadmin.Dg&&!e)return this.gridLayoutClass=Ajadmin.Dg.createDefaultLayout({collection:this.collection,gridRegions:{table:{view:Ajadmin.Dg.DefaultTableView.extend({itemView:Ajadmin.Dg.createRowView(this.modelClass,""+this.templatePath+"/row"),headerView:Ajadmin.Dg.createTableHeaderView(""+this.templatePath+"/headers")})}}})},o=function(e){if(e)return this.createViewClass=e.extend({model:this.modelClass}),this.createViewClass.prototype.controller=this},u=function(e){if(e)return this.editViewClass=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t}(e),this.editViewClass.prototype.controller=this},l=function(e){switch(e){case"create":return this.createViewClass.prototype.template!==void 0;case"edit":return this.editViewClass.prototype.template!==void 0}},p=function(e,t,n){var s,o=this;return e==="create"?s=""+this.collection.url+"/new":s=""+this.collection.url+"/"+n.model.get("id")+"/"+e,r.ajax({type:"GET",dataType:"html",processData:!1,url:s,success:function(r){switch(e){case"create":o.createViewClass.prototype.template=r;break;case"edit":o.editViewClass.prototype.template=r}return t(i.call(o,e),e,n)}})},i=function(e){switch(e){case"create":return this.createViewClass;case"edit":return this.editViewClass}},n=function(e,t){var n;return n=function(e,t,n){return c.crudView(e,t,n)},l.call(this,e)?n(i.call(this,e),e,t):p.call(this,e,n,t)},d.prototype.grid=function(){return c.switchModule(this.name,!1)},d.prototype.refresh=function(){return this.collection.refresh()},d.prototype.create=function(e){return n.call(this,"create",{model:e})},d.prototype.edit=function(e){return n.call(this,"edit",{model:e})},d}(),Admin.NavigationView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.switchModule=function(e){return this.trigger("navigate:switchModule",e)},t}(t.View),f={info:"datagrid.info",pager:{first:"datagrid.pager.first",last:"datagrid.pager.last",next:"datagrid.pager.next",previous:"datagrid.pager.previous",filler:"datagrid.pager.filler"}},Admin.setupDefaultI18nBindings=function(e){return f=n.defaults(e.i18n||{},f)},Admin.StatedCollection=e.Collection.extend({initialize:function(e){return this.current=n.defaults({},{page:1,ipp:2,quickSearch:"",sorting:{}})},sync:function(e,t,i){var s,o,u=this;return o=i.success,i.success=function(e,t){return o(e,t),u.trigger("fetched")},s=n.extend({},{jsonpCallback:"callback",timeout:25e3,cache:!1,type:"GET",dataType:"json",processData:!1,url:this.url,headers:{"X-Grid-Parameters":JSON.stringify(this.current)}},i),r.ajax(s)},parse:function(e,t){var n;return n=e.info,this.current.records=n.records,this.current.pages=n.pages,this.current.filteredRecords=n.filteredRecords,this.current.filteredPages=n.filteredPages,this.current.from=(this.current.page-1)*this.current.ipp+1,this.current.to=this.current.from+this.current.ipp-1,this.current.to>this.current.filteredRecords&&(this.current.to=this.current.filteredRecords),this.current.page>this.current.filteredPages&&this.current.filteredPages>0&&(this.current.page=this.current.filteredPages,this.fetch()),e.data},refresh:function(){return this.reset(),this.fetch()},getInfo:function(){return this.current},updateInfo:function(e){return this.current=n.defaults(e,this.current),this.fetch()}}),Admin.instanciateModule=function(e){var n,r;if(o)throw new Error("Application already started, it is not possible to register more modules.");return r=new s(e),n=t.AppRouter.extend({controller:r,appRoutes:r.getRoutes(),initialize:function(){return this.on("changeUrl",function(e){return this.changeUrl(e)})},changeUrl:function(e,t){var n,r,i;r=this.controller.getRoute(e);if(t)for(n in t)i=t[n],r=r.replace(":"+n,i);return this.navigate(r)}}),r.setRouter(new n),c.registerModule(r)},Admin.init=function(e){return l=!0,e=e||{},e.authorizator?u=new e.authorizator:u=new Admin.Authorizator},Admin.start=function(n){var r,i,s,u;l||Admin.init(),u=new t.EventBinder,o=!0;if(n===void 0)throw new Error("No option defined when some are required.");return n.mainRegion===void 0?i=Admin.MainRegion:i=n.mainRegion,n.navigationView!=null?s=n.navigationView:s=Admin.NavigationView,r=new t.Application,r.on("initialize:after",function(){return e.history.start({pushState:!0})}),a.on("changeView",function(e){return r.mainRegion.show(e)}),r.addInitializer(function(){var e;return e=new s,u.bindTo(e,"navigate:switchModule",c.switchModule,c),this.addRegions({mainRegion:i})}),r.start()},Admin.can=function(e,t){return u.can(e,t)},Admin.cannot=function(e,t){return u.cannot(e,t)},Admin}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender);