/*!
 * Backbone.Admin v0.0.1
 * Copyright (c) 2013 Laurent Pr√©vost (prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/backbone.admin
 */
var Admin,__hasProp={}.hasOwnProperty,__extends=function(e,t){function r(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return r.prototype=t.prototype,e.prototype=new r,e.__super__=t.prototype,e};Backbone.Admin=Admin=function(e,t,n,r){var i,s,o,u,a,f,l;return Admin={version:"0.0.1"},i=!1,a=!1,f=new RegExp(/[a-z]+(:[a-z]+)*/),o=new t.EventAggregator,s=null,l=function(e){var t;return t=n.map(e,function(e,t){return[t,e]}),n.sortBy(t,function(e){return e[1]})},Admin.ApplicationController=function(){function r(r){if(r===void 0)throw new Error("An application must be defined");if(!(r instanceof t.Application))throw new Error("Application should be Marionnette.Application");this.application=r,n.extend(this,e.Events),this.listenTo(this.router,"route",this.routeHandler)}return r.prototype.modules={},r.prototype.router=new e.Router,r.prototype.started=!1,r.prototype.routeHandler=function(e,t){return this.action(e,t)},r.prototype.action=function(e,t){var r,i,s,o,u,a,f,l,c;e.match(/.*:.*/g)?(o=e.replace(/:.*/,""),r=e.replace(/.*:/,"")):(o=e,r="main"),console.log("Options: "+t),console.log("Action: "+e),console.log("Action name: "+r),console.log("Module name: "+o),console.log("Modules: "+this.modules),s=this.modules[o],console.log("Module: "+s),u=s.actions[r],console.log("Path: "+u),r!=="main"&&t!==void 0&&(u=u.replace(":"+s.modelIdentifier,t.model.get(s.modelIdentifier))),console.log("Path replaced: "+u),a=s[r](t),console.log("Result: "+a),c=n.keys(a);for(f=0,l=c.length;f<l;f++)i=c[f],this.application[i]!==void 0&&this.application[i].show(a[i]);return this.router.navigate("/"+u)},r.prototype.registerModule=function(e){var t,r,i,s,o,u;if(e===void 0)throw new Error("The module cannot be undefined");if(e instanceof Admin.Module){if(this.modules[e.name]!==void 0)throw new Error("The module is already registered");this.modules[e.name]=e,s=n.chain(e.actions).pairs().sortBy(1).object().value(),r=this.action,o=function(e){return function(t){return r(e,t)}};for(i in s)u=s[i],t=""+e.name+":"+i,this.router.route(u,t);return this.listenTo(e,"action",this.action)}throw new Error("The module must be from Admin.Module type")},r.prototype.registerRegion=function(e,t){if(this.application[e]!==void 0)throw new Error("The region "+e+" is already registered");return this.application[e]=t},r.prototype.start=function(){return this.started?console.log("Application controller already started."):(this.application.start(),e.history.start({pushState:!0}))},r}(),Admin.NavigationView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.events={"click [data-action]":"action"},t.prototype.action=function(e){return e.preventDefault(),this.trigger("action",r(e.target).attr("data-action"))},t}(t.View),Admin.Module=function(){function r(t){if(this.name===void 0)throw new Error("The name of the module must be defined");if(this.actions===void 0)throw new Error("At least one action must be defined");this.baseUrl===void 0&&(this.baseUrl="/"+this.name.replace(/:/g,"/")),n.extend(this,e.Events)}var t;return r.prototype.action=function(e,t){return this.trigger("action",e,t)},t=function(e){},r}(),Admin.CrudModule=function(e){function n(e){n.__super__.constructor.call(this,e);if(this.collection===void 0)throw new Error("The collection must be specified");this.model===void 0&&this.collection.prototype.model!==void 0&&(this.model=this.collection.prototype.model);if(this.model===void 0)throw new Error("The model must be specified")}var t;return __extends(n,e),t=function(e){},n}(Admin.Module),Admin.MainRegion=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.el=".content",t}(t.Region),u={info:"datagrid.info",pager:{first:"datagrid.pager.first",last:"datagrid.pager.last",next:"datagrid.pager.next",previous:"datagrid.pager.previous",filler:"datagrid.pager.filler"}},Admin.setupDefaultI18nBindings=function(e){return u=n.defaults(e.i18n||{},u)},Admin.StatedCollection=e.Collection.extend({initialize:function(e){return this.current=n.defaults({},{page:1,ipp:2,quickSearch:"",sorting:{}})},sync:function(e,t,i){var s,o,u=this;return o=i.success,i.success=function(e,t){return o(e,t),u.trigger("fetched")},s=n.extend({},{jsonpCallback:"callback",timeout:25e3,cache:!1,type:"GET",dataType:"json",processData:!1,url:this.url,headers:{"X-Grid-Parameters":JSON.stringify(this.current)}},i),r.ajax(s)},parse:function(e,t){var n;return n=e.info,this.current.records=n.records,this.current.pages=n.pages,this.current.filteredRecords=n.filteredRecords,this.current.filteredPages=n.filteredPages,this.current.from=(this.current.page-1)*this.current.ipp+1,this.current.to=this.current.from+this.current.ipp-1,this.current.to>this.current.filteredRecords&&(this.current.to=this.current.filteredRecords),this.current.page>this.current.filteredPages&&this.current.filteredPages>0&&(this.current.page=this.current.filteredPages,this.fetch()),e.data},refresh:function(){return this.reset(),this.fetch()},getInfo:function(){return this.current},updateInfo:function(e){return this.current=n.defaults(e,this.current),this.fetch()}}),Admin.instanciateModule=function(e){var t;if(i)throw new Error("Application already started, it is not possible to register more modules.");return t=new ModuleController(e),mainController.registerModule(t)},Admin.init=function(e){return a=!0,e=e||{},e.authorizator?s=new e.authorizator:s=new Admin.Authorizator},Admin.start=function(n){var r,s,u,f,l;a||Admin.init(),i=!0;if(n===void 0)throw new Error("No option defined when some are required.");return n.mainRegion===void 0?s=Admin.MainRegion:s=n.mainRegion,n.navigationView!=null?u=n.navigationView:u=Admin.NavigationView,f=new e.Router,l=function(e){return f.route(e,e,function(){return alert(e)}),f.navigate(e,{trigger:!0})},r=new t.Application,r.on("initialize:after",function(){return e.history.start({pushState:!0})}),o.on("changeView",function(e){return r.mainRegion.show(e)}),r.addInitializer(function(){var e;return e=new u,e.on("navigate:switchModule",l),this.addRegions({mainRegion:s})}),r.start()},Admin.can=function(e,t){return s.can(e,t)},Admin.cannot=function(e,t){return s.cannot(e,t)},Admin}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender);