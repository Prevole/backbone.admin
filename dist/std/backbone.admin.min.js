/*
 * Backbone.Admin - v0.0.7
 * Copyright (c) 2013-04-23 Laurent Prevost (prevole) <prevole@prevole.ch>
 * Distributed under MIT license
 * https://github.com/prevole/backbone.admin
 */
(function(){var t={}.hasOwnProperty,e=function(e,i){function r(){this.constructor=e}for(var o in i)t.call(i,o)&&(e[o]=i[o]);return r.prototype=i.prototype,e.prototype=new r,e.__super__=i.prototype,e};window.Backbone.Admin=window.Admin=function(Backbone,t,i,r){var o,n,s,u,c;return s={version:"0.0.1"},u=null,i.mixin({wrapView:function(t){return i.object(["view"],[t])},retrieveModel:function(t,e){if(void 0===e)throw Error("Action must be defined");if(void 0===e.options)throw Error("Options in action must be defined");return void 0===e.options.model?t.get(e.options.id):e.options.model},slice:Function.prototype.call.bind(Array.prototype.slice)}),o=function(){function t(t,e,i,r){if(void 0===e)throw Error("The module must be defined");this.module=e||null,this.moduleName=this.module.name,this.name=i||"main",this.options=r||{},this.isRoutable=t||!1,this.updatedRegions={}}return t.prototype.route=function(){var t,e,i,r;if(void 0!==this.module.routeActions[this.name]){e=this.module.route(this.name),r=this.options;for(t in r)i=r[t],e=e.replace(":"+t,i);return e}},t}(),n=new(function(){function t(){}return t.prototype.action=function(t,e,i){return new o(!1,t,e,i)},t.prototype.routeAction=function(t,e,i){return new o(!0,t,e,i)},t.prototype.outsideAction=function(t,e,i,r){return t?this.routeAction(e,i,r):this.action(e,i,r)},t}()),s.ApplicationController=function(){function e(t){var e=this;i.extend(this,Backbone.Events),t=i.defaults(t||{},{router:Backbone.Router}),this.router=i.isBoolean(t.router)&&t.router?new Backbone.Router:i.isFunction(t.router)?new t.router(t):t.router,this.on("action:outside:route",function(t,i){return u.call(e,t,!0,i)}),this.on("action:outside:noroute",function(t,i){return u.call(e,t,!1,i)}),i.isNull(this.router)||this.listenTo(this.router,"route",function(t,i){return c.call(e,t,i)})}var r,o,u,c;return e.prototype.initializers=new t.Callbacks,e.prototype.triggerMethod=t.triggerMethod,e.prototype.modules={},e.prototype.regionNames=[],e.prototype.router=null,e.prototype.started=!1,e.prototype.addInitializer=function(t){return this.initializers.add(t)},e.prototype.start=function(t){return this.started?console.log("Application controller already started."):(this.triggerMethod("before:start",t),this.initializers.run(t,this),(!i.isNull(this.router)||Backbone.history.started)&&Backbone.history.start({pushState:!0}),this.triggerMethod("after:start",t))},u=function(t,e,i){var o,s,u;return s=t.split(":"),u=this.modules[s[0]],o=void 0===s[1]?"main":s[1],void 0!==u?r.call(this,n.outsideAction(e,u,o,i)):void 0},c=function(t,e){var o,s,u,c,a,l,d,h,f,p;if(s=t.split(":"),c=this.modules[s[0]],o=void 0===s[1]?"main":s[1],void 0!==c){if(a={},h=c.route(o),void 0!==h&&(d=h.match(/(\(\?)?:\w+/g),!i.isNull(d)))for(u=f=0,p=d.length-1;p>=0?p>=f:f>=p;u=p>=0?++f:--f)l=d[u].slice(1),a[l]=e[u],e[u]=null;return a._params=i.filter(e,function(t){return!i.isNull(t)}),r.call(this,n.action(c,o,a))}},r=function(t){return void 0!==t&&void 0!==t.module?t.module.trigger("action:execute",t):void 0},o=function(t){var e,r,o,n;if(!i.isNull(t.updatedRegions)){for(n=i.keys(t.updatedRegions),r=0,o=n.length;o>r;r++)e=n[r],void 0!==this[e]&&(this[e].close(),this[e].show(t.updatedRegions[e].view));if(!i.isNull(this.router)&&t.isRoutable)return this.router.navigate(t.route())}},e.prototype.registerModule=function(t){var e,n,u,c=this;if(void 0===t)throw Error("The module cannot be undefined");if(!(t instanceof s.Module))throw Error("The module must be from Admin.Module type");if(void 0!==this.modules[t.name])throw Error("The module is already registered");if(this.modules[t.name]=t,!i.isNull(this.router)){u=t.routes();for(e in u)n=u[e],this.router.route(n,""+t.name+":"+e)}return this.listenTo(t,"action:module",function(t){return r.call(c,t)}),this.listenTo(t,"action:executed",function(t){return o.call(c,t)})},e.prototype.registerRegion=function(t,e){if(void 0!==this[t])throw Error("The region "+t+" is already registered");return this[t]=e,this.regionNames.push(t)},e}(),s.NavigationView=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.prototype.events={"click [data-action]":"action"},i.prototype.initialize=function(t){if(void 0===this.applicationController){if(void 0===t.applicationController)throw Error("An application controller must be defined");return this.applicationController=t.applicationController}},i.prototype.action=function(t){return t.preventDefault(),this.applicationController.trigger("action:outside:route",r(t.target).attr("data-action"))},i}(t.View),s.Module=t.Controller.extend({constructor:function(){if(t.Controller.prototype.constructor.apply(this,i.slice(arguments)),void 0===this.name)throw Error("The name of the module must be defined");if(void 0===this.routeActions)throw Error("At least one route action must be defined");return void 0===this.basePath&&(this.basePath=""+this.name.replace(/:/g,"/")),this.basePath=i.str.endsWith(this.basePath,"/")?this.basePath:""+this.basePath+"/",this.on("action:route",function(t,e,i){return this.trigger("action:module",n.routeAction(this,t,e),i)}),this.on("action:noroute",function(t,e){return this.trigger("action:module",n.action(this,t,e))}),this.on("action:execute",function(t){return this.triggerMethod("action:"+t.name,t),this.trigger("action:executed",t)})},routes:function(){var t,e=this;return t=function(t,i,r){return t[r]=e.route(r),t},i.chain(i.reduce(this.routeActions,t,{})).pairs().sortBy(1).object().value()},route:function(t){var e;return e=this.routeActions[t],""===e?i.str.rtrim(this.basePath,"/"):""+this.basePath+i.str.ltrim(e,"/")}}),s.CrudModule=s.Module.extend({constructor:function(){if(s.Module.prototype.constructor.apply(this,i.slice(arguments)),void 0===this.collection)throw Error("The collection must be specified");if(i.isFunction(this.collection)?void 0===this.model&&void 0!==this.collection.prototype.model&&(this.model=this.collection.prototype.model):this.model=this.collection.model,void 0===this.model)throw Error("The model must be specified");if(void 0===this.views)throw Error("Views must be defined")},onActionMain:function(t){var e;return e=new this.views.main.view,this.listenTo(e,"new",function(){return this.trigger("action:route","create")}),this.listenTo(e,"edit",function(t){return this.trigger("action:route","edit",{id:t.get("id")},{model:t})}),this.listenTo(e,"delete",function(t){return this.trigger("action:noroute","delete",{model:t})}),t.updatedRegions[this.views.main.region]=i.wrapView(e)},onActionCreate:function(t){var e,r=this;return e=new this.views.create.view({model:new this.collection.model}),e.error&&e.listenTo(this,"create:invalid",e.error),this.listenTo(e,"create",function(t){var e;return e=r.triggerMethod("create",t),e?(r.trigger("created",e),r.trigger("action:route","main")):void 0}),t.updatedRegions[this.views.create.region]=i.wrapView(e)},onCreate:function(t){var e,r,o=this;return e=new this.collection.model(t,{url:this.collection.url}),this.listenTo(e,"invalid",function(t,e,i){return o.trigger("create:invalid",t,e,i)}),r=i.result(this,"createOptions")||{},e.isValid(r)?e.save(null,i.extend(r,{success:function(t,e,i){return o.triggerMethod("create:success",t,e,i)},error:function(t,e,i){return o.triggerMethod("create:error",t,e,i)}})):!1},onCreateSuccess:function(){},onCreateError:function(){},onActionEdit:function(t){var e;return e=new this.views.edit.view({model:i.retrieveModel(this.collection,t)}),e.listenTo(e.model,"invalid",e.error),this.listenTo(e,"edit",function(t){return this.triggerMethod("edit",e.model,t)?(this.trigger("edited",e.model),this.trigger("action:route","main")):void 0}),t.updatedRegions[this.views.edit.region]=i.wrapView(e)},onEdit:function(t,e){var r,o=this;return r=i.extend(i.result(this,"editOptions")||{},{validate:!0}),t.set(e,r)?t.save(null,i.extend(r,{validate:!1,success:function(t,e,i){return o.triggerMethod("edit:success",t,e,i)},error:function(t,e,i){return o.triggerMethod("edit:error",t,e,i)}})):!1},onEditSuccess:function(){},onEditError:function(){},onActionDelete:function(t){var e,r=this;e=new this.views["delete"].view({model:i.retrieveModel(this.collection,t)}),this.listenTo(e,"delete",function(t){return r.triggerMethod("delete",t)?r.trigger("deleted",t):void 0}),e.render()},onDelete:function(t){var e,r=this;return e=i.result(this,"deleteOptions")||{},t.destroy(i.extend(e,{success:function(t,e,i){return r.triggerMethod("delete:success",t,e,i)},error:function(t,e,i){return r.triggerMethod("delete:error",t,e,i)}}))},onDeleteSuccess:function(){},onDeleteError:function(){}}),s.FormView=Backbone.Marionette.ItemView.extend({events:{"click .create":"create","click .edit":"edit"},modelAttributes:function(){throw Error("Missing method getAttributes().")},create:function(t){return t.preventDefault(),this.trigger("create",this.modelAttributes())},edit:function(t){return t.preventDefault(),this.trigger("edit",this.modelAttributes())},error:function(){}}),s.DeleteView=t.ItemView.extend({events:{"click .no":"no","click .yes":"yes"},initialize:function(t){if(void 0===t||void 0===t.model)throw Error("No model given for the delete view when it is mandatory")},no:function(t){return t.preventDefault(),this.triggerMethod("no",t)},yes:function(t){return t.preventDefault(),this.triggerMethod("yes",t),this.trigger("delete",this.model)}}),s.MainRegion=function(t){function i(){return i.__super__.constructor.apply(this,arguments)}return e(i,t),i.prototype.el=".content",i}(t.Region),c={info:"datagrid.info",pager:{first:"datagrid.pager.first",last:"datagrid.pager.last",next:"datagrid.pager.next",previous:"datagrid.pager.previous",filler:"datagrid.pager.filler"}},s.setupDefaultI18nBindings=function(t){return c=i.defaults(t.i18n||{},c)},s.can=function(t,e){return u.can(t,e)},s.cannot=function(t,e){return u.cannot(t,e)},s}(Backbone,Backbone.Marionette,_,$||window.jQuery||window.Zepto||window.ender)}).call(this);